# For the antsy

## 
Assumes you have conda/miniconda installed, and have a working AWS account with CLI credentials ready to roll. Using `zsh` (on mac primarily tested for this part).

```bash
```zsh
# Currently, the sourced scripts expect zsh... please run from a zsh shell for these steps

# Get the repo locally
mkdir -p ~/projects
cd ~/projects
git clone git@github.com:Daylily-Informatics/daylily.git
cd daylily

# Run the following in tmux or similar as it will take a while
tmux new -s daylily-ref-clone

export AWS_PROFILE=<YOURPROFILE, default>

cd ~/projects/daylily

# Create daylily cli
source bin/init_daycli 

# Assess which AZ you wish to work in (note! pricing changes over time, and estimates provided are approxiamations, not promises)

bin/check_current_spot_market_by_zones.py -o ./zone_check.tsv --profile default  # choose the AZ you like best, and creae a bucket, then spin up a cluster in that AZ.


# Make a clone of the daylily-references-public bucket in your account
bash bin/create_daylily_omics_analysis_s3.sh --bucket-prefix <SHORTPREFIX> --region <REGION>  # This may take a few hours, depending on regions, etc.  And only needs to be done once per region. See more below.



# Create a new ephemeral cluster
source bin/daylily-cfg-ephemeral-cluster --region-az us-west-2c --pass-on-warn --profile default # you will be prompted for a variety of things, or asked to create them if missing.


# And that should be it.

# Install PCUI as the pcluster web interface to monitor/work with it from here.
echo "see README.md re: PCUI"
```

### Example check_current_spot_market_by_zones.py output
```text

30.0-cov genome @ vCPU-min per x align: 307.2 vCPU-min per x snvcall: 684.0 vCPU-min per x other: 0.021 vCPU-min per x svcall: 19.0
╒═══════════════════╤════════════╤═══════════╤═══════════╤═══════════╤════════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤═══════════╤════════════╤════════════╕
│ Region AZ         │   #        │    Median │      Min  │      Max  │   Harmonic │     Spot  │     FASTQ │      BAM  │      CRAM │      snv  │      snv  │      sv   │     Other │      $ per │   ~ EC2 $  │
│                   │   Instance │    Spot $ │      Spot │      Spot │   Mean     │     Stab- │     (GB)  │      (GB) │      (GB) │      VCF  │      gVCF │      VCF  │     (GB)  │   vCPU min │            │
│                   │   Types    │           │      $    │      $    │   Spot $   │     ility │           │           │           │      (GB) │      (GB) │      (GB) │           │   harmonic │   harmonic │
╞═══════════════════╪════════════╪═══════════╪═══════════╪═══════════╪════════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪═══════════╪════════════╪════════════╡
│ 1. us-west-2a     │          6 │   3.66280 │   2.33530 │   8.95920 │    3.57403 │   6.62390 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00031 │    9.40251 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 2. us-west-2b     │          6 │   2.71335 │   0.93580 │   7.28880 │    2.26075 │   6.35300 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00020 │    5.94755 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 3. us-west-2c     │          6 │   2.74405 │   1.10640 │   6.08420 │    2.14516 │   4.97780 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00019 │    5.64347 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 4. us-west-2d     │          6 │   1.76745 │   0.85980 │   5.60170 │    1.71453 │   4.74190 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00015 │    4.51056 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 5. us-east-1a     │          6 │   2.65125 │   1.41510 │   4.30600 │    2.30512 │   2.89090 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00020 │    6.06426 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 6. us-east-1b     │          6 │   3.00675 │   0.88170 │   7.14330 │    2.38622 │   6.26160 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00021 │    6.27764 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 7. us-east-1c     │          6 │   3.60500 │   0.98910 │   4.68220 │    2.56585 │   3.69310 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00022 │    6.75020 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 8. us-east-1d     │          6 │   1.85310 │   0.85680 │   5.97720 │    1.53724 │   5.12040 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00013 │    4.04415 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 9. ap-south-1a    │          6 │   1.97530 │   1.48510 │   3.93110 │    2.10080 │   2.44600 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00018 │    5.52676 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 10. ap-south-1b   │          6 │   1.50315 │   1.38290 │   2.03280 │    1.58099 │   0.64990 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00014 │    4.15925 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 11. ap-south-1c   │          6 │   1.38210 │   1.10470 │   1.73490 │    1.37944 │   0.63020 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00012 │    3.62901 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 12. ap-south-1d   │          0 │ nan       │ nan       │ nan       │  nan       │ nan       │ nan       │ nan       │ nan       │ nan       │ nan       │ nan       │ nan       │  nan       │  nan       │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 13. eu-central-1a │          6 │   6.16090 │   2.59150 │  15.25970 │    4.83673 │  12.66820 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00042 │   12.72439 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 14. eu-central-1b │          6 │   1.89305 │   1.53220 │   3.09790 │    2.00038 │   1.56570 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00017 │    5.26256 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 15. eu-central-1c │          6 │   1.96865 │   1.49400 │   3.39290 │    1.99048 │   1.89890 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00017 │    5.23651 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 16. ca-central-1a │          6 │   3.72215 │   3.31300 │   4.97770 │    3.88997 │   1.66470 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00034 │   10.23368 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 17. ca-central-1b │          6 │   3.67825 │   3.14120 │   4.97120 │    3.78215 │   1.83000 │  49.50000 │  39.00000 │  13.20000 │   0.12000 │   1.20000 │   0.12000 │   0.00300 │    0.00033 │    9.95002 │
├───────────────────┼────────────┼───────────┼───────────┼───────────┼────────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼───────────┼────────────┼────────────┤
│ 18. ca-central-1c │          0 │ nan       │ nan       │ nan       │  nan       │ nan       │ nan       │ nan       │ nan       │ nan       │ nan       │ nan       │ nan       │  nan       │  nan       │
╘═══════════════════╧════════════╧═══════════╧═══════════╧═══════════╧════════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧═══════════╧════════════╧════════════╛
Select the availability zone by number:
```



## AWS Account
- Create a user with CLI credentials.
  - Store them in `~/.aws/credentials` & verify they work with `aws s3 ls s3://a-bucket`.
- Add the required permissions to your user (see README.md, and/or run the `bin/daylily-cfg-ephemeral-cluster` to check on your user permissions.
- Clone the `daylily-references-public` s3 bucket to a bucket in your account & in the AZ you wish to operate in (the source bucket is in `us-west-2`, it will be faster and cheaper to replicate this in the same region.  However, this bucket only needs to be present 1x/AZ, and does not need to be cloned again in the same region).  Run this command: 
```bash
bash bin/create_daylily_omics_analysis_s3.sh --bucket-prefix <SHORTPREFIX> --region <REGION> 
```
- Which will let you know what will happen when you run the actual command with `--disable-warn` and `--disable-dryrun`: *WITH THESE FLAGS SET, A NEW BUCKET WILL BE CREATED NAMED* `<SHORTPREFIX>-omics-analysis-<REGION>`, this bucket will be used for all ephemeral clusters created in this region.  _note:_ the bucket is ~500G in size, and you will be billed ~$20 to clone the source bucket, then responsible for ongoing storage costs.  The bucket includes references to work with `b37` as well as `hg38` and includes 7 GIAB google-brain 30x 2x150 fastqs. You may remove the references and reads if you do not intend to use them.

