#!/usr/bin/env bash
# This script is intended to be sourced, not executed directly.

# Check if DAY_ROOT is set; if not, source dayinit
if [[ -z "$DAY_ROOT" ]]; then
    source dayinit
fi

envi="$1"

echo "Requesting environment: $envi"

# Attempt to deactivate any existing environment
source bin/day_deactivate &> /dev/null || {
    echo "Attempted to deactivate existing environments but an error occurred."
    echo "Proceeding, but please check your PATH after completion."
}

# Source the environment installer
source config/day/day_env_installer.sh DAY
ret_code=$?

# Handle build argument
if [[ "$1" == "BUILD" && "$ret_code" != "0" ]]; then
    source config/day/day_env_installer.sh DAY config/day/
    ret_code=$?
else
    if [[ "$1" =~ ^(-h|--help|help)$ ]]; then
        echo "Usage: day-build [BUILD]"
        echo "This script builds the DAY conda environment (only needed once per working environment)."
        echo "Run 'day-build BUILD' to install conda and the DAY environment."
        return 0
    fi
fi

# Source dayinit for local setup
source dayinit local &> /dev/null

# Check if 'colr' command is available
if ! command -v colr &> /dev/null; then
    if [[ "$ret_code" == "0" ]]; then
        echo "SUCCESS! 'colr' package is missing; attempting to install it now."
        pip install colr docopt
    else
        echo "ERROR: Command returned code $ret_code."
        echo "Try running a test: 'day-activate local; day-run test-local -c 3 -j 2 seqqc'"
        return $ret_code
    fi
elif [[ "$ret_code" == "919" ]]; then
    echo "Warning: Command returned a non-passing state."
    return 0
else
    if [[ "$ret_code" != "0" ]]; then

    if [[ "$ret_code" != "0" ]]; then
        source bin/utils/col_error.bash
        echo "ERROR: Something went wrong. Check the README for alternate install instructions."
        return $ret_code
    else
        echo "GREAT SUCCESS!"
        export PS1="$DYPS1 $PS1"
        source dayinit local &> /dev/null
        echo "Please start a new bash session and test the install:"
        echo "  bash;"
        echo "  source dayinit;"
        echo "  dy-a local"
        echo "  dy-r help"
    fi
fi

return 0
