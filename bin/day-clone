#!/usr/bin/env bash

set -e

CONFIG_FILE="$HOME/.config/daylily/daylily_cli_global.yaml"

git_tag=$(yq '.daylily.git_tag' "$CONFIG_FILE")
git_repo=$(yq '.daylily.git_repo' "$CONFIG_FILE")

# Defaults
user_name="$USER"

print_help() {
  cat <<EOF
Usage: $(basename "$0") [OPTIONS]

Options:
  -t, --git-tag       Git tag to clone (default from $CONFIG_FILE)
  -r, --git-repo      Git repository URL (default from $CONFIG_FILE)
  -c, --clone-root    Root directory to clone into (required)
  -u, --user-name     Username to create directory as (default: $USER)
  -h, --help          Show this help message and exit
EOF
}

# Parse command-line arguments
while [[ $# -gt 0 ]]; do
  case "$1" in
    -t|--git-tag)
      git_tag="$2"
      shift; shift
      ;;
    -r|--git-repo)
      git_repo="$2"
      shift; shift
      ;;
    -c|--clone-root)
      clone_root="$2"
      shift; shift
      ;;
    -u|--user-name)
      user_name="$2"
      shift; shift
      ;;
    -h|--help)
      print_help
      exit 0
      ;;
    *)
      echo "Unknown option: $1"
      print_help
      exit 1
      ;;
  esac
done

# Required parameter check
if [ -z "$clone_root" ]; then
  echo "Error: --clone-root (-c) is required."
  print_help
  exit 1
fi

if [ ! -d "$clone_root" ]; then
  echo "Error: clone_root directory '$clone_root' does not exist."
  exit 1
fi

if [ -z "$user_name" ]; then
  user_name="$USER"
fi

if [ ! -d "$clone_root/$user_name" ]; then
  echo "Warning: Directory '$clone_root/$user_name' does not exist. Creating."
  mkdir -p "$clone_root/$user_name" || { echo "Failed to create directory"; exit 1; }
fi

cd "$clone_root/$user_name"

if [ -z "$git_repo" ]; then
  git_repo=$(yq '.daylily.git_repo' "$CONFIG_FILE")
fi

if [ -z "$git_tag" ]; then
  git_tag=$(yq '.daylily.git_tag' "$CONFIG_FILE")
fi

if [ -z "$destination" ]; then
  destination=$(basename "$git_repo" .git)
fi

if [ -d "$destination" ]; then
  echo "Error: directory '$destination' already exists."
  exit 1
fi

# Clone the repo
git clone --branch "$git_tag" "$git_repo" "$destination" || { echo "Git clone failed"; exit 1; }

cd "$destination"

cat <<EOF
Great Success!
Daylily $git_tag has been cloned to $(pwd) & you are ready to roll.
   run '. dyinit' to init your daylily environment and see further instructions.
   you can create a samples.tsv as described in the README.md then run 'bin/daylily-analysis.sh'
EOF